<p-toast position="top-left"></p-toast>
<p-confirmPopup>
  <ng-template pTemplate="content" let-message>
    <div
      class="flex flex-column align-items-center w-full gap-3 border-bottom-1 surface-border p-3 mb-3">
      <i [class]="message.icon" class="text-6xl text-primary-500"></i>
      <p>{{ message.message }}</p>
    </div>
  </ng-template>
</p-confirmPopup>

<div
  class="fixed top-0 flex align-items-center gap-2 justify-content-center w-full surface-50 text-primary"
  style="height: 35px">
  Feito por Jean Talar
  <i class="pi pi-face-smile"></i>
</div>

<main class="container" style="margin-top: 35px">
  <div class="grid">
    <div class="col-12 text-center">
      <p-fileUpload
        mode="advanced"
        chooseLabel="Selecione os arquivos"
        chooseIcon="pi pi-upload"
        accept=".xml"
        [multiple]="true"
        [showUploadButton]="false"
        [showCancelButton]="false"
        (onSelect)="onFilesSelected($event)">
        <ng-template let-files pTemplate="content">
          @if (files.length) { Esqueceu algum xml? Adicione mais arquivos arrastando-os até aqui! }
        </ng-template>
        <ng-template pTemplate="file"></ng-template>
        <ng-template pTemplate="toolbar">
          <p-button
            (onClick)="confirmExcelLayout($event)"
            label="Gerar Excel"
            icon="pi pi-file-excel"></p-button>
        </ng-template>
      </p-fileUpload>
    </div>
    <div class="custom-line"></div>
    <div class="card w-full">
      <div class="flex justify-content-center">
        <p-progressSpinner
          styleClass="w-4rem h-4rem"
          strokeWidth="4"
          ariaLabel="Carregando..."
          styleClass="custom-spinner"
          *ngIf="isLoading">
        </p-progressSpinner>
      </div>
      <p-tree
        (onNodeDrop)="cancel($event)"
        [value]="filesNode"
        [draggableNodes]="true"
        [droppableNodes]="true"
        draggableScope="self"
        droppableScope="self">
        <ng-template pTemplate="empty">
          <p-message styleClass="mt-2" severity="info" text="Nenhum arquivo selecionado ainda">
          </p-message>
        </ng-template>
        <ng-template pTemplate="header">
          <div class="flex align-items-center justify-content-between mb-3">
            <h2 class="my-1">Ordene os arquivos selecionados</h2>
            <p-button
              [disabled]="isLoading || filesNode.length === 0"
              label="Nova Carga"
              styleClass="uppercase"
              [rounded]="true"
              icon="pi pi-plus"
              severity="success"
              (onClick)="addNodeGroup()"
              size="small">
            </p-button>
          </div>
        </ng-template>
        <ng-template let-node pTemplate="default">
          <div class="flex align-items-center gap-2 w-full hover-button-wrapper">
            <div class="flex-grow-1 grid m-0 gap-2">
              <div class="col-2">
                {{ node.label }}
              </div>
              <div class="col-3" *ngIf="!node.parent">
                @if (node.data.motorista) {
                <div class="text-overflow-ellipsis white-space-nowrap overflow-hidden">
                  {{ node.data.motorista }}
                </div>
                }
              </div>
              <div class="col-2" *ngIf="!node.parent">
                @if (node.data.contrato) {
                <i class="pi pi-paperclip"></i>
                {{ node.data.contrato }}
                }
              </div>
              <div class="col-2" *ngIf="!node.parent">
                @if (node.data.cheque) {
                <i class="pi pi-money-bill"></i>
                {{ node.data.cheque }}
                }
              </div>
              <div class="col-2" *ngIf="!node.parent">
                @if (node.data.dataPagamento) {
                <i class="pi pi-calendar"></i>
                {{ node.data.dataPagamento | date : 'd/MMM' : 'pt-br' }}
                }
              </div>
            </div>
            <div class="flex g-2">
              <p-overlayPanel #op>
                <ng-template pTemplate="content">
                  <div class="field">
                    <label class="block" for="motorista">Motorista</label>
                    <input
                      id="motorista"
                      type="text"
                      pInputText
                      [ngModel]="node.data.motorista"
                      (ngModelChange)="uppercaseMotorista($event, node.data)" />
                  </div>
                  <div class="field">
                    <label class="block" for="contrato">N° contrato</label>
                    <p-inputNumber
                      id="contrato"
                      type="text"
                      [(ngModel)]="node.data.contrato"
                      maxlength="4"
                      [useGrouping]="false" />
                  </div>
                  <div class="field">
                    <label class="block" for="cheque">N° cheque</label>
                    <p-inputNumber
                      id="cheque"
                      type="text"
                      [(ngModel)]="node.data.cheque"
                      maxlength="5"
                      [useGrouping]="false" />
                  </div>
                  <div class="field">
                    <label class="block" for="pagamento">Data de pagamento</label>
                    <p-calendar
                      id="pagamento"
                      [(ngModel)]="node.data.dataPagamento"
                      [showButtonBar]="true"
                      dateFormat="dd/mm/yy">
                    </p-calendar>
                  </div>
                </ng-template>
              </p-overlayPanel>
              <p-button
                *ngIf="!node.parent"
                (onClick)="addNodeGroupBeforeNode(node.key)"
                class="hover-button"
                size="small"
                [rounded]="true"
                pTooltip="Inserir carga no item anterior"
                [text]="true"
                icon="pi pi-truck">
              </p-button>
              <p-button
                *ngIf="!node.parent"
                (click)="op.toggle($event)"
                size="small"
                [rounded]="true"
                pTooltip="Editar informações adicionais"
                [text]="true"
                icon="pi pi-pencil">
              </p-button>
              <p-button
                icon="pi pi-times"
                [rounded]="true"
                [text]="true"
                size="small"
                (onClick)="deleteNode(node)"
                [pTooltip]="node.droppable ? 'Remover carga' : 'Remover CT-e'"
                severity="danger">
              </p-button>
            </div>
          </div>
        </ng-template>
      </p-tree>
    </div>
  </div>
</main>

<div class="fixed flex gap-2 right-0 bottom-0 p-5">
  <p-button
    icon="pi pi-angle-up"
    [rounded]="true"
    size="large"
    (onClick)="scrollPage(true)"
    [text]="true"
    pTooltip="Ir para o topo da página">
  </p-button>
  <p-button
    icon="pi pi-angle-down"
    [rounded]="true"
    size="large"
    (onClick)="scrollPage(false)"
    [text]="true"
    pTooltip="Ir para o final da página">
  </p-button>
</div>
